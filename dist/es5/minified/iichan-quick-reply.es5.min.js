"use strict";function _slicedToArray(e,n){return _arrayWithHoles(e)||_iterableToArrayLimit(e,n)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,n){var t=[],r=!0,i=!1,a=void 0;try{for(var c,l=e[Symbol.iterator]();!(r=(c=l.next()).done)&&(t.push(c.value),!n||t.length!==n);r=!0);}catch(e){i=!0,a=e}finally{try{r||null==l.return||l.return()}finally{if(i)throw a}}return t}function _arrayWithHoles(e){if(Array.isArray(e))return e}!function(){var e,n,t,r={main:{key:"mainpage",dummy:"",url:"/cgi-bin/captcha1.pl/b/"},quick:{key:"mainpage",dummy:"",url:"/cgi-bin/captcha1.pl/b/"}},i=function(){var e=document.createElement("table");return e.insertAdjacentHTML("beforeend",'\n      <tr>\n      \t<td class="doubledash">&gt;&gt;</td>\n      \t<td class="iichan-postform-container reply">\n         <div class="theader">Ответ в тред №<span class="iichan-quick-reply-thread"></span><div class="iichan-quick-reply-close-form-btn" title="Закрыть форму"><svg>\n          <use class="iichan-icon-form-close-use" xlink:href="/extras/icons.svg#iichan-icon-close" width="16" height="16" viewBox="0 0 16 16"/>\n        </svg></div></div>\n        </td>\n      </tr>\n      \n    '),e.id="iichan-quick-reply-container",e.querySelector(".iichan-quick-reply-close-form-btn").addEventListener("click",function(e){return v(null)}),{quickReplyContainer:e,quickPostformContainer:e.querySelector(".iichan-postform-container")}}(),a=i.quickReplyContainer,c=i.quickPostformContainer,l=function(){return e||(e=document.getElementById("postform")),e},o=function(){if(!n){var e=l();(n=e.cloneNode(!0)).id="iichan-quick-reply-form";var t=n.querySelector("#captcha");t&&(t.id="iichan-quick-reply-captcha"),s(n),document.body.classList.contains("replypage")&&(n.addEventListener("change",b),n.addEventListener("input",b)),c.appendChild(n)}return n},u=((t=document.createElement("input")).setAttribute("type","hidden"),t.setAttribute("name","parent"),t),s=function(e){var n=e.querySelector("input[name=captcha] + a");n&&(n.removeAttribute("onclick"),n.addEventListener("click",function(e){y(),e.preventDefault()}))},d=function(e){var n=e.url,t=e.key,r=e.dummy;return"".concat(n,"?key=").concat(t,"&dummy=").concat(r,"&").concat(Math.random())},y=function(){var e=document.getElementById("iichan-quick-reply-captcha"),n=document.getElementById("captcha"),t=d(r.quick);e&&(e.src=t),n&&(r.quick.key===r.main.key?n.src=t:n.src=d(r.main))},p=function(e){if(e){var n=e.id.substr("thread-".length),t=e.querySelector("table:last-child .reply"),i=t?t.id.substr("reply".length):n;r.quick.key="res".concat(n),r.quick.dummy=i}else r.quick.key="mainpage",r.quick.dummy="";y()},m=function(e,n){var t=a.querySelector(".iichan-quick-reply-thread");t&&(t.textContent=n||"");var r=e.querySelector("[name=parent]");n?(r||(r=u,e.appendChild(r)),r.setAttribute("value",n)):r&&e.removeChild(r)},f=function(e,n){for(var t=e;t&&t!==document&&!t.matches(n);)t=t.parentNode;return t===document?null:t},h=function(e,n){var t=e&&e.querySelector("[name=nya4]");t&&(t.focus(),n&&(n=">>".concat(n,"\n"),t.value.endsWith(n)||(t.value.length&&!t.value.endsWith("\n")&&(n="\n"+n),t.setRangeText(n,t.textLength,t.textLength,"end"))),document.body.classList.contains("replypage")&&b(t))},v=function(e){var n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],t=o();e&&t.dataset.replyTo!==e.id?e.classList.contains("reply")||e.classList.contains("highlight")?(t.dataset.replyTo=e.id,function(e,n){var t=o(),r=f(e,"table"),i=f(e,"[id^=thread]");if(r&&i){var c=i.id.substr("thread-".length),l=e.id.substr("reply".length);r.parentNode.insertBefore(a,r.nextSibling),m(t,c),p(i),n&&h(t,l)}}(e,n)):(t.dataset.replyTo=e.id,function(e,n){var t=o(),r=e.querySelector("table"),i=e.id.substr("thread-".length);e.insertBefore(a,r),m(t,i),p(e),n&&h(t,i)}(e,n)):(t.dataset.replyTo="",a.parentNode&&a.parentNode.removeChild(a))},b=function(e){if(e){var n=e instanceof Event?e.target:e,t=o(),r=l(),i=t.contains(n)?r:t,a=t.contains(n)?t:r,c=i[n.name],u=n.type;if(c)if("radio"===u){var s=a[n.name];c.value=s.value}else if("checkbox"===u)c.checked=n.checked;else if("file"===u){var d=n.cloneNode(),y=c.parentElement;y.removeChild(c),y.insertBefore(d,y.firstChild)}else c.value=n.value}},g=function(e){for(var n=e.target;n&&!n.classList.contains("iichan-quick-reply-btn");)n=n.parentElement;if(n){var t=document.getElementById(n.dataset.postId);v(t)}e.preventDefault()},k=function(e){var n="",t=f(e.target,"[id^=reply]"),r=f(e.target,"[id^=thread]");if(t?n=t.id.substr("reply".length):r&&(n=r.id.substr("thread-".length)),n)if(a.parentNode){var i=o();h(i,n),e.preventDefault()}else if(document.body.classList.contains("replypage")){var c=l();h(c,n),e.preventDefault()}},q=function(e){if(!_()){var n=E(),t=o(),r=t.querySelector("textarea");(a.parentNode||r.value)&&(n.lastQuickReply=t.dataset.replyTo,n.lastUrl=window.location.href,n.timestamp=Date.now(),document.body.classList.contains("replypage")||(n.formData=function(e){var n={},t=e.querySelectorAll("input, textarea"),r=!0,i=!1,a=void 0;try{for(var c,l=t[Symbol.iterator]();!(r=(c=l.next()).done);r=!0){var o=c.value;if(o.name&&"file"!==o.type)if(n[o.name]={type:o.type},"radio"===o.type){var u=e[o.name];n[o.name].value=u.value}else"checkbox"===o.type?n[o.name].checked=o.checked:n[o.name].value=o.value}}catch(e){i=!0,a=e}finally{try{r||null==l.return||l.return()}finally{if(i)throw a}}return n}(t))),A(n)}},x=function(){if(!_()){var e=E();if(e.lastUrl===window.location.href&&e.timestamp){var n=Date.now()-e.timestamp;if(!L()||n>18e4)return e.lastUrl=null,e.lastQuickReply=null,e.timestamp=null,e.formData=null,void A(e);if(e.lastQuickReply){var t=document.getElementById(e.lastQuickReply);v(t,!1)}if(!document.body.classList.contains("replypage")&&e.formData)!function(e,n){var t=e.querySelectorAll("input, textarea"),r=!0,i=!1,a=void 0;try{for(var c,l=t[Symbol.iterator]();!(r=(c=l.next()).done);r=!0){var o=c.value;n[o.name]&&n[o.name].type===o.type&&("radio"===o.type?e[o.name].value=n[o.name].value:"checkbox"===o.type?o.checked=n[o.name].checked:o.value=n[o.name].value)}}catch(e){i=!0,a=e}finally{try{r||null==l.return||l.return()}finally{if(i)throw a}}}(o(),e.formData);e.lastUrl=null,e.lastQuickReply=null,e.timestamp=null,e.formData=null,A(e)}}},w=function(e){if(e){var n=e.querySelector(":scope > .reflink");if(n){var t=e.querySelector(".iichan-post-btns");t||((t=document.createElement("span")).classList.add("iichan-post-btns"),n.parentNode.insertBefore(t,n.nextSibling)),t.insertAdjacentHTML("beforeend",'\n    <div class="iichan-quick-reply-btn" title="Быстрый ответ" data-post-id="'.concat(e.id,'">\n      <svg>\n        <use class="iichan-icon-reply-use" xlink:href="/extras/icons.svg#iichan-icon-reply" width="16" height="16" viewBox="0 0 16 16"/>\n      </svg>\n    </div>\n  ').trim()),e.querySelector(".iichan-quick-reply-btn").addEventListener("click",g);var r=n.querySelector("a");r&&r.addEventListener("click",k)}}},S=function(e){if(e&&e.matches(".reply, [id^=thread]"))w(e);else{var n=(e||document.body).querySelectorAll(".reply, [id^=thread]"),t=!0,r=!1,i=void 0;try{for(var a,c=n[Symbol.iterator]();!(t=(a=c.next()).done);t=!0){var l=a.value;w(l)}}catch(e){r=!0,i=e}finally{try{t||null==c.return||c.return()}finally{if(r)throw i}}}},L=function(){var e=window.performance;if(!e)return!1;var n=e.navigation;return!!n&&(n.type===n.TYPE_RELOAD||n.type===n.TYPE_BACK_FORWARD)},E=function(){return JSON.parse(window.localStorage.getItem("iichan_quick_reply")||"{}")},A=function(e){return window.localStorage.setItem("iichan_quick_reply",JSON.stringify(e))},_=function(){return document.body.classList.contains("de-runned")||!!document.body.querySelector("#de-main")},T=function(){if(!_()&&(document.getElementById("delform"),!JSON.parse(window.localStorage.getItem("iichan_settings")||"{}").disable_quick_reply)){var e=l();if(e){window.addEventListener("beforeunload",q);var n=document.body.querySelector("#captcha");if(n){var t=_slicedToArray(n.getAttribute("src").match(/([^\?]*)\?key=(.*)&dummy=(.*)/),4),i=(t[0],t[1]),a=t[2],c=t[3];r.main.url=i,r.main.key=a,r.main.dummy=c,r.quick.url=i}if(s(e),document.body.classList.contains("replypage")&&(e.addEventListener("change",b),e.addEventListener("input",b)),document.head.insertAdjacentHTML("beforeend",'<style type="text/css">\n      .iichan-quick-reply-btn {\n        display: inline-block;\n        width: 16px;\n        height: 16px;\n        vertical-align: text-top;\n      }\n      \n      .iichan-quick-reply-btn > svg {\n        width: 16px;\n        height: 16px;\n      }\n      \n      .iichan-quick-reply-btn use {\n        pointer-events: none;\n      }\n      \n      .iichan-quick-reply-btn {\n        margin-left: 0.4em;\n        cursor: pointer;\n      }\n      \n      #iichan-quick-reply-container .rules {\n        display: none;\n      }\n      \n      #iichan-quick-reply-icons {\n        display: none;\n      }\n      \n      .iichan-postform-container .theader {\n        width: auto;\n      }\n      \n      .iichan-quick-reply-close-form-btn {\n        float: right;\n        cursor: pointer;\n        padding: 1px;\n      }\n      \n      .iichan-quick-reply-close-form-btn svg {\n        width: 16px;\n        height: 16px;\n        vertical-align: text-top;\n      }\n      \n      .iichan-quick-reply-close-form-btn use {\n        pointer-events: none;\n      }\n      \n      @media only screen and (max-width: 480px) {\n        .iichan-postform-container table {\n          margin: 0;\n          width: 100%;\n        }\n      }\n      \n      .iichan-postform-container table {\n        margin: 0px auto;\n        text-align: left;\n      }\n      \n    </style>'),S(),x(),"MutationObserver"in window)new MutationObserver(function(e){_()||e.forEach(function(e){var n=!0,t=!1,r=void 0;try{for(var i,a=e.addedNodes[Symbol.iterator]();!(n=(i=a.next()).done);n=!0){var c=i.value;if(!c.querySelectorAll)return;S(c)}}catch(e){t=!0,r=e}finally{try{n||null==a.return||a.return()}finally{if(t)throw r}}})}).observe(document.body,{childList:!0,subtree:!0})}}};document.body?T():document.addEventListener("DOMContentLoaded",T)}();