"use strict";function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var n=[],r=!0,i=!1,a=void 0;try{for(var c,l=e[Symbol.iterator]();!(r=(c=l.next()).done)&&(n.push(c.value),!t||n.length!==t);r=!0);}catch(e){i=!0,a=e}finally{try{r||null==l.return||l.return()}finally{if(i)throw a}}return n}function _arrayWithHoles(e){if(Array.isArray(e))return e}!function(){var e,t,n,r={main:{key:"mainpage",dummy:"",url:"/cgi-bin/captcha1.pl/b/"},quick:{key:"mainpage",dummy:"",url:"/cgi-bin/captcha1.pl/b/"}},i=function(){var e=document.createElement("table");return e.insertAdjacentHTML("beforeend",'\n      <tr>\n      \t<td class="doubledash">&gt;&gt;</td>\n      \t<td class="iichan-postform-container reply">\n         <div class="theader">Ответ в тред №<span class="iichan-quick-reply-thread"></span><div class="iichan-quick-reply-close-form-btn" title="Закрыть форму"><svg>\n          <use class="iichan-icon-form-close-use" xlink:href="/extras/icons.svg#iichan-icon-close" width="16" height="16" viewBox="0 0 16 16"/>\n        </svg></div></div>\n        </td>\n      </tr>\n      \n    '),e.id="iichan-quick-reply-container",e.querySelector(".iichan-quick-reply-close-form-btn").addEventListener("click",function(e){return v(null)}),{quickReplyContainer:e,quickPostformContainer:e.querySelector(".iichan-postform-container")}}(),a=i.quickReplyContainer,c=i.quickPostformContainer,l=function(){return e||(e=document.getElementById("postform")),e},o=function(){if(!t){var e=l();(t=e.cloneNode(!0)).id="iichan-quick-reply-form";var n=t.querySelector("#captcha");n&&(n.id="iichan-quick-reply-captcha"),d(t),document.body.classList.contains("replypage")&&(t.addEventListener("change",b),t.addEventListener("input",b)),c.appendChild(t)}return t},u=((n=document.createElement("input")).setAttribute("type","hidden"),n.setAttribute("name","parent"),n),d=function(e){var t=e.querySelector("input[name=captcha] + a");t&&(t.removeAttribute("onclick"),t.addEventListener("click",function(e){y(),e.preventDefault()}))},s=function(e){var t=e.url,n=e.key,r=e.dummy;return"".concat(t,"?key=").concat(n,"&dummy=").concat(r,"&").concat(Math.random())},y=function(){var e=document.getElementById("iichan-quick-reply-captcha"),t=document.getElementById("captcha"),n=s(r.quick);e&&(e.src=n),t&&(r.quick.key===r.main.key?t.src=n:t.src=s(r.main))},p=function(e){if(e){var t=e.id.substr("thread-".length),n=e.querySelector("table:last-child .reply"),i=n?n.id.substr("reply".length):t;r.quick.key="res".concat(t),r.quick.dummy=i}else r.quick.key="mainpage",r.quick.dummy="";y()},f=function(e,t){var n=a.querySelector(".iichan-quick-reply-thread");n&&(n.textContent=t||"");var r=e.querySelector("[name=parent]");t?(r||(r=u,e.appendChild(r)),r.setAttribute("value",t)):r&&e.removeChild(r)},m=function(e,t){for(var n=e;n&&n!==document&&!n.matches(t);)n=n.parentNode;return n===document?null:n},h=function(e,t){var n=e&&e.querySelector("[name=nya4]");n&&(n.focus(),t&&(t=">>".concat(t,"\n"),n.value.endsWith(t)||(n.value.length&&!n.value.endsWith("\n")&&(t="\n"+t),n.setRangeText(t,n.textLength,n.textLength,"end"))),document.body.classList.contains("replypage")&&b(n))},v=function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=o();e&&n.dataset.replyTo!==e.id?e.classList.contains("reply")?(n.dataset.replyTo=e.id,function(e,t){var n=o(),r=m(e,"table"),i=m(e,"[id^=thread]");if(r&&i){var c=i.id.substr("thread-".length),l=e.id.substr("reply".length);r.parentNode.insertBefore(a,r.nextSibling),f(n,c),p(i),t&&h(n,l)}}(e,t)):(n.dataset.replyTo=e.id,function(e,t){var n=o(),r=e.querySelector("table"),i=e.id.substr("thread-".length);e.insertBefore(a,r),f(n,i),p(e),t&&h(n,i)}(e,t)):(n.dataset.replyTo="",a.parentNode&&a.parentNode.removeChild(a))},b=function(e){if(e){var t=e instanceof Event?e.target:e,n=o(),r=l(),i=n.contains(t)?r:n,a=n.contains(t)?n:r,c=i[t.name],u=t.type;if(c)if("radio"===u){var d=a[t.name];c.value=d.value}else if("checkbox"===u)c.checked=t.checked;else if("file"===u){var s=t.cloneNode(),y=c.parentElement;y.removeChild(c),y.insertBefore(s,y.firstChild)}else c.value=t.value}},k=function(e){for(var t=e.target;t&&!t.classList.contains("iichan-quick-reply-btn");)t=t.parentElement;if(t){var n=document.getElementById(t.dataset.postId);v(n)}e.preventDefault()},g=function(e){var t="",n=m(e.target,".reply"),r=m(e.target,"[id^=thread]");if(n?t=n.id.substr("reply".length):r&&(t=r.id.substr("thread-".length)),t)if(a.parentNode){var i=o();h(i,t),e.preventDefault()}else if(document.body.classList.contains("replypage")){var c=l();h(c,t),e.preventDefault()}},q=function(e){if(!_()&&a.parentNode){var t=E(),n=o();t.lastQuickReply=n.dataset.replyTo,t.lastUrl=window.location.href,t.timestamp=Date.now(),document.body.classList.contains("replypage")||(t.formData=function(e){var t={},n=e.querySelectorAll("input, textarea"),r=!0,i=!1,a=void 0;try{for(var c,l=n[Symbol.iterator]();!(r=(c=l.next()).done);r=!0){var o=c.value;if(o.name&&"file"!==o.type)if(t[o.name]={type:o.type},"radio"===o.type){var u=e[o.name];t[o.name].value=u.value}else"checkbox"===o.type?t[o.name].checked=o.checked:t[o.name].value=o.value}}catch(e){i=!0,a=e}finally{try{r||null==l.return||l.return()}finally{if(i)throw a}}return t}(n)),A(t)}},w=function(){if(!_()){var e=E();if(e.lastUrl===window.location.href&&e.timestamp){var t=Date.now()-e.timestamp;if(!L()||t>18e4)return e.lastUrl=null,e.lastQuickReply=null,e.timestamp=null,e.formData=null,void A(e);if(e.lastQuickReply){var n=document.getElementById(e.lastQuickReply);if(v(n,!1),!document.body.classList.contains("replypage")&&e.formData)!function(e,t){var n=e.querySelectorAll("input, textarea"),r=!0,i=!1,a=void 0;try{for(var c,l=n[Symbol.iterator]();!(r=(c=l.next()).done);r=!0){var o=c.value;t[o.name]&&t[o.name].type===o.type&&("radio"===o.type?e[o.name].value=t[o.name].value:"checkbox"===o.type?o.checked=t[o.name].checked:o.value=t[o.name].value)}}catch(e){i=!0,a=e}finally{try{r||null==l.return||l.return()}finally{if(i)throw a}}}(o(),e.formData)}e.lastUrl=null,e.lastQuickReply=null,e.timestamp=null,e.formData=null,A(e)}}},x=function(e){if(e){var t=e.querySelector(":scope > .reflink");if(t){var n=e.querySelector(".iichan-post-btns");n||((n=document.createElement("span")).classList.add("iichan-post-btns"),t.parentNode.insertBefore(n,t.nextSibling)),n.insertAdjacentHTML("beforeend",'\n    <div class="iichan-quick-reply-btn" title="Быстрый ответ" data-post-id="'.concat(e.id,'">\n      <svg>\n        <use class="iichan-icon-reply-use" xlink:href="/extras/icons.svg#iichan-icon-reply" width="16" height="16" viewBox="0 0 16 16"/>\n      </svg>\n    </div>\n  ').trim()),e.querySelector(".iichan-quick-reply-btn").addEventListener("click",k);var r=t.querySelector("a");r&&r.addEventListener("click",g)}}},S=function(e){if(e&&e.matches(".reply, [id^=thread]"))x(e);else{var t=(e||document.body).querySelectorAll(".reply, [id^=thread]"),n=!0,r=!1,i=void 0;try{for(var a,c=t[Symbol.iterator]();!(n=(a=c.next()).done);n=!0){var l=a.value;x(l)}}catch(e){r=!0,i=e}finally{try{n||null==c.return||c.return()}finally{if(r)throw i}}}},L=function(){var e=window.performance;if(!e)return!1;var t=e.navigation;return!!t&&(t.type===t.TYPE_RELOAD||t.type===t.TYPE_BACK_FORWARD)},E=function(){return JSON.parse(window.localStorage.getItem("iichan_quick_reply")||"{}")},A=function(e){return window.localStorage.setItem("iichan_quick_reply",JSON.stringify(e))},_=function(){return document.body.classList.contains("de-runned")||!!document.body.querySelector("#de-main")},T=function(){if(!_()&&(document.getElementById("delform"),!JSON.parse(window.localStorage.getItem("iichan_settings")||"{}").disable_quick_reply)){var e=l();if(e){window.addEventListener("beforeunload",q);var t=document.body.querySelector("#captcha");if(t){var n=_slicedToArray(t.getAttribute("src").match(/([^\?]*)\?key=(.*)&dummy=(.*)/),4),i=(n[0],n[1]),a=n[2],c=n[3];r.main.url=i,r.main.key=a,r.main.dummy=c,r.quick.url=i}if(d(e),document.body.classList.contains("replypage")&&(e.addEventListener("change",b),e.addEventListener("input",b)),document.head.insertAdjacentHTML("beforeend",'<style type="text/css">\n      .iichan-quick-reply-btn {\n        display: inline-block;\n        width: 16px;\n        height: 16px;\n        vertical-align: text-top;\n      }\n      \n      .iichan-quick-reply-btn > svg {\n        width: 16px;\n        height: 16px;\n      }\n      \n      .iichan-quick-reply-btn use {\n        pointer-events: none;\n      }\n      \n      .iichan-quick-reply-btn {\n        margin-left: 0.4em;\n        cursor: pointer;\n      }\n      \n      #iichan-quick-reply-container .rules {\n        display: none;\n      }\n      \n      #iichan-quick-reply-icons {\n        display: none;\n      }\n      \n      .iichan-postform-container .theader {\n        width: auto;\n      }\n      \n      .iichan-quick-reply-close-form-btn {\n        float: right;\n        cursor: pointer;\n        padding: 1px;\n      }\n      \n      .iichan-quick-reply-close-form-btn svg {\n        width: 16px;\n        height: 16px;\n        vertical-align: text-top;\n      }\n      \n      .iichan-quick-reply-close-form-btn use {\n        pointer-events: none;\n      }\n      \n    </style>'),S(),w(),"MutationObserver"in window)new MutationObserver(function(e){_()||e.forEach(function(e){var t=!0,n=!1,r=void 0;try{for(var i,a=e.addedNodes[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var c=i.value;if(!c.querySelectorAll)return;S(c)}}catch(e){n=!0,r=e}finally{try{t||null==a.return||a.return()}finally{if(n)throw r}}})}).observe(document.body,{childList:!0,subtree:!0})}}};document.body?T():document.addEventListener("DOMContentLoaded",T)}();