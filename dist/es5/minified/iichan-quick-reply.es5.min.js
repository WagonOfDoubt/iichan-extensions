"use strict";function _slicedToArray(e,n){return _arrayWithHoles(e)||_iterableToArrayLimit(e,n)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,n){var t=[],i=!0,r=!1,a=void 0;try{for(var c,o=e[Symbol.iterator]();!(i=(c=o.next()).done)&&(t.push(c.value),!n||t.length!==n);i=!0);}catch(e){r=!0,a=e}finally{try{i||null==o.return||o.return()}finally{if(r)throw a}}return t}function _arrayWithHoles(e){if(Array.isArray(e))return e}!function(){var e,n,t,i={main:{key:"mainpage",dummy:"",url:"/cgi-bin/captcha1.pl/b/"},quick:{key:"mainpage",dummy:"",url:"/cgi-bin/captcha1.pl/b/"}},r=function(){var e=document.createElement("table");return e.insertAdjacentHTML("beforeend",'\n      <tr>\n      \t<td class="doubledash">&gt;&gt;</td>\n      \t<td class="iichan-postform-container reply">\n         <div class="theader">Ответ в тред №<span class="iichan-quick-reply-thread"></span><div class="iichan-quick-reply-close-form-btn" title="Закрыть форму"><svg>\n          <use class="iichan-icon-form-close-use" xlink:href="/extras/icons.svg#iichan-icon-close" width="16" height="16" viewBox="0 0 16 16"/>\n        </svg></div></div>\n        </td>\n      </tr>\n      \n    '),e.id="iichan-quick-reply-container",e.querySelector(".iichan-quick-reply-close-form-btn").addEventListener("click",function(e){return m(null)}),{quickReplyContainer:e,quickPostformContainer:e.querySelector(".iichan-postform-container")}}(),a=r.quickReplyContainer,c=r.quickPostformContainer,o=function(){return e||(e=document.getElementById("postform")),e},l=function(){if(!n){var e=o();(n=e.cloneNode(!0)).id="iichan-quick-reply-form";var t=n.querySelector("#captcha");t&&(t.id="iichan-quick-reply-captcha"),s(n),document.body.classList.contains("replypage")&&(n.addEventListener("change",b),n.addEventListener("input",b)),c.appendChild(n)}return n},u=((t=document.createElement("input")).setAttribute("type","hidden"),t.setAttribute("name","parent"),t),s=function(e){var n=e.querySelector("input[name=captcha] + a");n&&(n.removeAttribute("onclick"),n.addEventListener("click",function(e){y(),e.preventDefault()}))},d=function(e){var n=e.url,t=e.key,i=e.dummy;return"".concat(n,"?key=").concat(t,"&dummy=").concat(i,"&").concat(Math.random())},y=function(){var e=document.getElementById("iichan-quick-reply-captcha"),n=document.getElementById("captcha"),t=d(i.quick);e&&(e.src=t),n&&(i.quick.key===i.main.key?n.src=t:n.src=d(i.main))},p=function(e){if(e){var n=e.id.substr("thread-".length),t=e.querySelector("table:last-child .reply"),r=t?t.id.substr("reply".length):n;i.quick.key="res".concat(n),i.quick.dummy=r}else i.quick.key="mainpage",i.quick.dummy="";y()},h=function(e,n){var t=a.querySelector(".iichan-quick-reply-thread");t&&(t.textContent=n||"");var i=e.querySelector("[name=parent]");n?(i||(i=u,e.appendChild(i)),i.setAttribute("value",n)):i&&e.removeChild(i)},f=function(e,n){for(var t=e;t&&t!==document&&!t.matches(n);)t=t.parentNode;return t===document?null:t},v=function(e,n){var t=e&&e.querySelector("[name=nya4]");t&&(t.focus(),n&&(n=">>".concat(n,"\n"),t.value.endsWith(n)||(t.value.length&&!t.value.endsWith("\n")&&(n="\n"+n),t.setRangeText(n,t.textLength,t.textLength,"end"))),document.body.classList.contains("replypage")&&b(t))},m=function(e){var n=l();e&&n.dataset.replyTo!==e.id?e.classList.contains("reply")?(n.dataset.replyTo=e.id,function(e){var n=l(),t=f(e,"table"),i=f(e,"[id^=thread]");if(t&&i){var r=i.id.substr("thread-".length),c=e.id.substr("reply".length);t.parentNode.insertBefore(a,t.nextSibling),h(n,r),p(i),v(n,c)}}(e)):(n.dataset.replyTo=e.id,function(e){var n=l(),t=e.querySelector("table"),i=e.id.substr("thread-".length);e.insertBefore(a,t),h(n,i),p(e),v(n,i)}(e)):(n.dataset.replyTo="",a.parentNode&&a.parentNode.removeChild(a))},b=function(e){var n=e instanceof Event?e.target:e,t=l(),i=o(),r=t.contains(n)?i:t,a=t.contains(n)?t:i,c=r[n.name],u=n.type;if(c)if("radio"===u){var s=a[n.name];c.value=s.value}else if("checkbox"===u)c.checked=n.checked;else if("file"===u){var d=n.cloneNode(),y=c.parentElement;y.removeChild(c),y.insertBefore(d,y.firstChild)}else c.value=n.value},g=function(e){for(var n=e.target;n&&!n.classList.contains("iichan-quick-reply-btn");)n=n.parentElement;if(n){var t=document.getElementById(n.dataset.postId);m(t)}e.preventDefault()},k=function(e){var n="",t=f(e.target,".reply"),i=f(e.target,"[id^=thread]");if(t?n=t.id.substr("reply".length):i&&(n=i.id.substr("thread-".length)),n)if(a.parentNode){var r=l();v(r,n)}else if(document.body.classList.contains("replypage")){var c=o();v(c,n)}else{m(t||i)}e.preventDefault()},q=function(e){if(e){var n=e.querySelector(":scope > .reflink");if(n){n.insertAdjacentHTML("afterend",'\n    <div class="iichan-quick-reply-btn" title="Быстрый ответ" data-post-id="'.concat(e.id,'">\n      <svg>\n        <use class="iichan-icon-reply-use" xlink:href="/extras/icons.svg#iichan-icon-reply" width="16" height="16" viewBox="0 0 16 16"/>\n      </svg>\n    </div>\n  ')),e.querySelector(".iichan-quick-reply-btn").addEventListener("click",g);var t=n.querySelector("a");t&&t.addEventListener("click",k)}}},x=function(e){if(e&&e.matches(".reply, [id^=thread]"))q(e);else{var n=(e||document.body).querySelectorAll(".reply, [id^=thread]"),t=!0,i=!1,r=void 0;try{for(var a,c=n[Symbol.iterator]();!(t=(a=c.next()).done);t=!0){var o=a.value;q(o)}}catch(e){i=!0,r=e}finally{try{t||null==c.return||c.return()}finally{if(i)throw r}}}},L=function(){return document.body.classList.contains("de-runned")||!!document.body.querySelector("#de-main")},S=function(){if(!L()&&!JSON.parse(window.localStorage.getItem("iichan_settings")||"{}").disable_quick_reply){var e=o();if(e){var n=document.body.querySelector("#captcha");if(n){var t=_slicedToArray(n.getAttribute("src").match(/([^\?]*)\?key=(.*)&dummy=(.*)/),4),r=(t[0],t[1]),a=t[2],c=t[3];i.main.url=r,i.main.key=a,i.main.dummy=c,i.quick.url=r}if(s(e),document.body.classList.contains("replypage")&&(e.addEventListener("change",b),e.addEventListener("input",b)),document.head.insertAdjacentHTML("beforeend",'<style type="text/css">\n      .iichan-quick-reply-btn {\n        display: inline-block;\n        width: 16px;\n        height: 16px;\n        vertical-align: text-top;\n      }\n      \n      .iichan-quick-reply-btn > svg {\n        width: 16px;\n        height: 16px;\n      }\n      \n      .iichan-quick-reply-btn use {\n        pointer-events: none;\n      }\n      \n      .iichan-quick-reply-btn {\n        cursor: pointer;\n      }\n      \n      #iichan-quick-reply-container .rules {\n        display: none;\n      }\n      \n      #iichan-quick-reply-icons {\n        display: none;\n      }\n      \n      .iichan-postform-container .theader {\n        width: auto;\n      }\n      \n      .iichan-quick-reply-close-form-btn {\n        float: right;\n        cursor: pointer;\n        padding: 1px;\n      }\n      \n      .iichan-quick-reply-close-form-btn svg {\n        width: 16px;\n        height: 16px;\n        vertical-align: text-top;\n      }\n      \n      .iichan-quick-reply-close-form-btn use {\n        pointer-events: none;\n      }\n      \n    </style>'),x(),"MutationObserver"in window)new MutationObserver(function(e){L()||e.forEach(function(e){console.log(e);var n=!0,t=!1,i=void 0;try{for(var r,a=e.addedNodes[Symbol.iterator]();!(n=(r=a.next()).done);n=!0){var c=r.value;if(!c.querySelectorAll)return;x(c)}}catch(e){t=!0,i=e}finally{try{n||null==a.return||a.return()}finally{if(t)throw i}}})}).observe(document.body,{childList:!0,subtree:!0})}}};document.body?S():document.addEventListener("DOMContentLoaded",S)}();