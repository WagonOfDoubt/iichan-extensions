(()=>{const e={main:{key:"mainpage",dummy:"",url:"/cgi-bin/captcha1.pl/b/"},quick:{key:"mainpage",dummy:"",url:"/cgi-bin/captcha1.pl/b/"}},{quickReplyContainer:n,quickPostformContainer:t}=(()=>{const e=document.createElement("table");return e.insertAdjacentHTML("beforeend",'\n      <tr>\n      \t<td class="doubledash">&gt;&gt;</td>\n      \t<td class="iichan-postform-container reply">\n         <div class="theader">Ответ в тред №<span class="iichan-quick-reply-thread"></span><div class="iichan-quick-reply-close-form-btn" title="Закрыть форму"><svg>\n          <use class="iichan-icon-form-close-use" xlink:href="/icons.svg#iichan-icon-close" width="16" height="16" viewBox="0 0 16 16"/>\n        </svg></div></div>\n        </td>\n      </tr>\n      \n    '),e.id="iichan-quick-reply-container",e.querySelector(".iichan-quick-reply-close-form-btn").addEventListener("click",e=>h(null)),{quickReplyContainer:e,quickPostformContainer:e.querySelector(".iichan-postform-container")}})(),i=(()=>{let e;return()=>(e||(e=document.getElementById("postform")),e)})(),c=(()=>{let e;return()=>{if(!e){const n=i();(e=n.cloneNode(!0)).id="iichan-quick-reply-form",e.querySelector("#captcha").id="iichan-quick-reply-captcha",a(e),document.body.classList.contains("replypage")&&(e.addEventListener("change",y),e.addEventListener("input",y)),t.appendChild(e)}return e}})(),r=(()=>{const e=document.createElement("input");return e.setAttribute("type","hidden"),e.setAttribute("name","parent"),e})(),a=e=>{const n=e.querySelector("input[name=captcha] + a");n&&(n.removeAttribute("onclick"),n.addEventListener("click",e=>{s(),e.preventDefault()}))},o=e=>{const{url:n,key:t,dummy:i}=e;return`${n}?key=${t}&dummy=${i}&${Math.random()}`},s=()=>{const n=document.getElementById("iichan-quick-reply-captcha"),t=document.getElementById("captcha"),i=o(e.quick);n&&(n.src=i),t&&(e.quick.key===e.main.key?t.src=i:t.src=o(e.main))},l=n=>{if(n){const t=n.id.substr("thread-".length),i=n.querySelector("table:last-child .reply"),c=i?i.id.substr("reply".length):t;e.quick.key=`res${t}`,e.quick.dummy=c}else e.quick.key="mainpage",e.quick.dummy="";s()},d=(e,t)=>{const i=n.querySelector(".iichan-quick-reply-thread");i&&(i.textContent=t||"");let c=e.querySelector("[name=parent]");t?(c||(c=r,e.appendChild(c)),c.setAttribute("value",t)):c&&e.removeChild(c)},u=(e,n)=>{let t=e;for(;t&&t!==document&&!t.matches(n);)t=t.parentNode;return t===document?null:t},p=(e,n)=>{const t=e&&e.querySelector("[name=nya4]");t&&(t.focus(!1),n&&(n=`>>${n}\n`,t.value.endsWith(n)||(t.value.length&&!t.value.endsWith("\n")&&(n="\n"+n),t.setRangeText(n,t.textLength,t.textLength,"end"))),y(t))},h=e=>{const t=c();e&&t.dataset.replyTo!==e.id?e.classList.contains("reply")?(t.dataset.replyTo=e.id,(e=>{const t=c(),i=u(e,"table"),r=u(e,"[id^=thread]");if(!i||!r)return;const a=r.id.substr("thread-".length),o=e.id.substr("reply".length);i.parentNode.insertBefore(n,i.nextSibling),d(t,a),l(r),p(t,o)})(e)):(t.dataset.replyTo=e.id,(e=>{const t=c(),i=e.querySelector("table"),r=e.id.substr("thread-".length);e.insertBefore(n,i),d(t,r),l(e),p(t,r)})(e)):(t.dataset.replyTo="",n.parentNode&&n.parentNode.removeChild(n))},y=e=>{const n=e instanceof Event?e.target:e,t=c(),r=i(),a=t.contains(n)?r:t,o=t.contains(n)?t:r,s=a[n.name],l=n.type;if(console.log(n),s)if("radio"===l){const e=o[n.name];s.value=e.value}else if("checkbox"===l)s.checked=n.checked;else if("file"===l){const e=n.cloneNode(),t=s.parentElement;t.removeChild(s),t.insertBefore(e,t.firstChild)}else s.value=n.value},m=e=>{let n=e.target;for(;n&&!n.classList.contains("iichan-quick-reply-btn");)n=n.parentElement;if(n){const e=document.getElementById(n.dataset.postId);h(e)}e.preventDefault()},k=e=>{if(!e)return;const n=e.querySelector(":scope > .reflink");n&&(n.insertAdjacentHTML("afterend",`\n    <div class="iichan-quick-reply-btn" title="Быстрый ответ" data-post-id="${e.id}">\n      <svg>\n        <use class="iichan-icon-reply-use" xlink:href="/icons.svg#iichan-icon-reply" width="16" height="16" viewBox="0 0 16 16"/>\n      </svg>\n    </div>\n  `),e.querySelector(".iichan-quick-reply-btn").addEventListener("click",m))},f=e=>{const n=(e||document).querySelectorAll(".reply, [id^=thread]");for(const e of n)k(e)},q=()=>{if(document.querySelector("#de-main"))return;const n=i();if(!n)return;const t=document.querySelector("#captcha");if(t){const n=t.getAttribute("src"),[i,c,r,a]=n.match(/([^\?]*)\?key=(.*)&dummy=(.*)/);e.main.url=c,e.main.key=r,e.main.dummy=a,e.quick.url=c}if(a(n),document.body.classList.contains("replypage")&&(n.addEventListener("change",y),n.addEventListener("input",y)),document.head.insertAdjacentHTML("beforeend",'<style type="text/css">\n      .iichan-quick-reply-btn {\n        display: inline-block;\n        width: 16px;\n        height: 16px;\n        vertical-align: text-top;\n      }\n      \n      .iichan-quick-reply-btn > svg {\n        width: 16px;\n        height: 16px;\n      }\n      \n      .iichan-quick-reply-btn use {\n        pointer-events: none;\n      }\n      \n      .iichan-quick-reply-btn {\n        cursor: pointer;\n      }\n      \n      #iichan-quick-reply-container .rules {\n        display: none;\n      }\n      \n      #iichan-quick-reply-icons {\n        display: none;\n      }\n      \n      .iichan-postform-container .theader {\n        width: auto;\n      }\n      \n      .iichan-quick-reply-close-form-btn {\n        float: right;\n        cursor: pointer;\n        padding: 1px;\n      }\n      \n      .iichan-quick-reply-close-form-btn svg {\n        width: 16px;\n        height: 16px;\n        vertical-align: text-top;\n      }\n      \n      .iichan-quick-reply-close-form-btn use {\n        pointer-events: none;\n      }\n      \n    </style>'),f(),"MutationObserver"in window){new MutationObserver(e=>{e.forEach(e=>{for(const n of e.addedNodes){if(!n.querySelectorAll)return;f(n)}})}).observe(document.body,{childList:!0,subtree:!0})}};document.body?q():document.addEventListener("DOMContentLoaded",q)})();