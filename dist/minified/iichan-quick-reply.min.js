(()=>{const e={key:"mainpage",dummy:"",url:"/cgi-bin/captcha1.pl/b/"},{quickReplyContainer:n,postformContainer:t}=(()=>{const e=document.createElement("table");return e.insertAdjacentHTML("beforeend",'\n        <tr>\n        \t<td class="doubledash">&gt;&gt;</td>\n        \t<td class="iichan-postform-container reply">\n           <div class="theader">Ответ в тред №<span class="iichan-quick-reply-thread"></span><div class="iichan-quick-reply-close-form-btn" title="Закрыть форму"><svg>\n            <use class="iichan-icon-form-close-use" xlink:href="/icons.svg#iichan-icon-close" width="16" height="16" viewBox="0 0 16 16"/>\n          </svg></div></div>\n          </td>\n        </tr>\n        \n      '),e.id="iichan-quick-reply-container",e.querySelector(".iichan-quick-reply-close-form-btn").addEventListener("click",e=>p(null,!0)),{quickReplyContainer:e,postformContainer:e.querySelector(".iichan-postform-container")}})(),r=(()=>{const e=document.createElement("a");return e.classList.add("iichan-quick-reply-show-form-btn"),e})(),i=(()=>{const e=document.createElement("input");return e.setAttribute("type","hidden"),e.setAttribute("name","parent"),e})(),c=()=>{const n=document.querySelector("#captcha");if(!n)return;const{url:t,key:r,dummy:i}=e;n.src=`${t}?key=${r}&dummy=${i}&${Math.random()}`},o=n=>{if(n){const t=n.id.substr("thread-".length),r=n.querySelector("table:last-child .reply"),i=r?r.id.substr("reply".length):t;e.key=`res${t}`,e.dummy=i}else e.key="mainpage",e.dummy="";c()},a=(e,t)=>{const r=n.querySelector(".iichan-quick-reply-thread");r&&(r.textContent=t||"");let c=e.querySelector("[name=parent]");t?(c||(c=i,e.appendChild(c)),c.setAttribute("value",t)):c&&e.removeChild(c)},s=(e,n)=>{let t=e;for(;t&&t!==document&&!t.matches(n);)t=t.parentNode;return t===document?null:t},l=e=>{const n=document.querySelector("[name=nya4]");n&&(n.focus(!1),e&&(e=`>>${e}\n`,n.value.endsWith(e)||(n.value.length&&!n.value.endsWith("\n")&&(e="\n"+e),n.setRangeText(e,n.textLength,n.textLength,"end"))))},d=()=>{const e=document.querySelector(".postarea");e&&e.appendChild(r);const n=document.querySelector("body > .theader");n&&(n.style.display="none")},u=(e,t)=>{const i=document.querySelector(".postarea");if(i&&(i.appendChild(e),t&&l()),n.parentNode&&n.parentNode.removeChild(n),r.parentNode){const e=document.querySelector("body > .theader");e&&(e.style.display=null),r.parentNode.removeChild(r)}if(document.body.classList.contains("replypage")){const n=document.querySelector("[id^=thread]"),t=n.id.substr("thread-".length);a(e,t),o(n)}else a(e,null),o()},p=(e,r)=>{const i=document.querySelector("#postform");i&&(e?i.dataset.replyTo===e.id?(i.dataset.replyTo="",u(i,!1)):e.classList.contains("reply")?(i.dataset.replyTo=e.id,((e,r)=>{const i=s(r,"table"),c=s(r,"[id^=thread]");if(!i||!c)return;const u=c.id.substr("thread-".length),p=r.id.substr("reply".length);t.appendChild(e),i.parentNode.insertBefore(n,i.nextSibling),d(),a(e,u),o(c),l(p)})(i,e)):(i.dataset.replyTo=e.id,((e,r)=>{const i=r.querySelector("table"),c=r.id.substr("thread-".length);t.appendChild(e),r.insertBefore(n,i),d(),a(e,c),o(r),l(c)})(i,e)):(i.dataset.replyTo="",u(i,!r)))},h=e=>{let n=e.target;for(;n&&!n.classList.contains("iichan-quick-reply-btn");)n=n.parentElement;if(n){const e=document.getElementById(n.dataset.postId);p(e)}e.preventDefault()},y=e=>{if(!e)return;const n=e.querySelector(":scope > .reflink");n&&(n.insertAdjacentHTML("afterend",`\n    <div class="iichan-quick-reply-btn" title="Быстрый ответ" data-post-id="${e.id}">\n      <svg>\n        <use class="iichan-icon-reply-use" xlink:href="/icons.svg#iichan-icon-reply" width="16" height="16" viewBox="0 0 16 16"/>\n      </svg>\n    </div>\n  `),e.querySelector(".iichan-quick-reply-btn").addEventListener("click",h))},m=e=>{const n=(e||document).querySelectorAll(".reply, [id^=thread]");for(const e of n)y(e)},f=()=>{if(document.querySelector("#de-main"))return;const n=document.querySelector("#captcha");n&&(e.url=n.getAttribute("src").match(/[^\?]*/)[0]);const t=document.querySelector("input[name=captcha] + a");if(t&&(t.removeAttribute("onclick"),t.addEventListener("click",e=>{c(),e.preventDefault()})),document.body.classList.contains("replypage")){const e=document.querySelector("[id^=thread]");o(e)}else o();if(document.head.insertAdjacentHTML("beforeend","<style type=\"text/css\">\n      .iichan-quick-reply-btn {\n        display: inline-block;\n        width: 16px;\n        height: 16px;\n        vertical-align: text-top;\n      }\n      \n      .iichan-quick-reply-btn > svg {\n        width: 16px;\n        height: 16px;\n      }\n      \n      .iichan-quick-reply-btn use {\n        pointer-events: none;\n      }\n      \n      .replypage .iichan-quick-reply-show-form-btn::after {\n        content: '[Показать форму ответа]';\n      }\n      \n      .iichan-quick-reply-show-form-btn::after {\n        content: '[Создать тред]';\n      }\n      \n      .iichan-quick-reply-show-form-btn,\n      .iichan-quick-reply-btn {\n        cursor: pointer;\n      }\n      \n      #iichan-quick-reply-container .rules {\n        display: none;\n      }\n      \n      #iichan-quick-reply-icons {\n        display: none;\n      }\n      \n      .iichan-postform-container .theader {\n        width: auto;\n      }\n      \n      .iichan-quick-reply-close-form-btn {\n        float: right;\n        cursor: pointer;\n        padding: 1px;\n      }\n      \n      .iichan-quick-reply-close-form-btn svg {\n        width: 16px;\n        height: 16px;\n        vertical-align: text-top;\n      }\n      \n      .iichan-quick-reply-close-form-btn use {\n        pointer-events: none;\n      }\n      \n    </style>"),m(),r.addEventListener("click",e=>{p(),e.preventDefault()}),"MutationObserver"in window){new MutationObserver(e=>{e.forEach(e=>{for(const n of e.addedNodes){if(!n.querySelectorAll)return;m(n)}})}).observe(document.body,{childList:!0,subtree:!0})}};document.body?f():document.addEventListener("DOMContentLoaded",f)})();