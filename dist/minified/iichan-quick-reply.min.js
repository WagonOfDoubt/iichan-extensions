(()=>{const e={main:{key:"mainpage",dummy:"",url:"/cgi-bin/captcha1.pl/b/"},quick:{key:"mainpage",dummy:"",url:"/cgi-bin/captcha1.pl/b/"}},{quickReplyContainer:t,quickPostformContainer:n}=(()=>{const e=document.createElement("table");return e.insertAdjacentHTML("beforeend",'\n      <tr>\n      \t<td class="doubledash">&gt;&gt;</td>\n      \t<td class="iichan-postform-container reply">\n         <div class="theader">Ответ в тред №<span class="iichan-quick-reply-thread"></span><div class="iichan-quick-reply-close-form-btn" title="Закрыть форму"><svg>\n          <use class="iichan-icon-form-close-use" xlink:href="/extras/icons.svg#iichan-icon-close" width="16" height="16" viewBox="0 0 16 16"/>\n        </svg></div></div>\n        </td>\n      </tr>\n      \n    '),e.id="iichan-quick-reply-container",e.querySelector(".iichan-quick-reply-close-form-btn").addEventListener("click",e=>y(null)),{quickReplyContainer:e,quickPostformContainer:e.querySelector(".iichan-postform-container")}})(),i=(()=>{let e;return()=>(e||(e=document.getElementById("postform")),e)})(),r=(()=>{let e;return()=>{if(!e){const t=i();(e=t.cloneNode(!0)).id="iichan-quick-reply-form";const r=e.querySelector("#captcha");r&&(r.id="iichan-quick-reply-captcha"),c(e),document.body.classList.contains("replypage")&&(e.addEventListener("change",m),e.addEventListener("input",m)),n.appendChild(e)}return e}})(),a=(()=>{const e=document.createElement("input");return e.setAttribute("type","hidden"),e.setAttribute("name","parent"),e})(),c=e=>{const t=e.querySelector("input[name=captcha] + a");t&&(t.removeAttribute("onclick"),t.addEventListener("click",e=>{l(),e.preventDefault()}))},o=e=>{const{url:t,key:n,dummy:i}=e;return`${t}?key=${n}&dummy=${i}&${Math.random()}`},l=()=>{const t=document.getElementById("iichan-quick-reply-captcha"),n=document.getElementById("captcha"),i=o(e.quick);t&&(t.src=i),n&&(e.quick.key===e.main.key?n.src=i:n.src=o(e.main))},s=t=>{if(t){const n=t.id.substr("thread-".length),i=t.querySelector("table:last-child .reply"),r=i?i.id.substr("reply".length):n;e.quick.key=`res${n}`,e.quick.dummy=r}else e.quick.key="mainpage",e.quick.dummy="";l()},d=(e,n)=>{const i=t.querySelector(".iichan-quick-reply-thread");i&&(i.textContent=n||"");let r=e.querySelector("[name=parent]");n?(r||(r=a,e.appendChild(r)),r.setAttribute("value",n)):r&&e.removeChild(r)},u=(e,t)=>{let n=e;for(;n&&n!==document&&!n.matches(t);)n=n.parentNode;return n===document?null:n},p=(e,t)=>{const n=e&&e.querySelector("[name=nya4]");n&&(n.focus(),t&&(t=`>>${t}\n`,n.value.endsWith(t)||(n.value.length&&!n.value.endsWith("\n")&&(t="\n"+t),n.setRangeText(t,n.textLength,n.textLength,"end"))),document.body.classList.contains("replypage")&&m(n))},y=(e,n=!0)=>{const i=r();e&&i.dataset.replyTo!==e.id?e.classList.contains("reply")?(i.dataset.replyTo=e.id,((e,n)=>{const i=r(),a=u(e,"table"),c=u(e,"[id^=thread]");if(!a||!c)return;const o=c.id.substr("thread-".length),l=e.id.substr("reply".length);a.parentNode.insertBefore(t,a.nextSibling),d(i,o),s(c),n&&p(i,l)})(e,n)):(i.dataset.replyTo=e.id,((e,n)=>{const i=r(),a=e.querySelector("table"),c=e.id.substr("thread-".length);e.insertBefore(t,a),d(i,c),s(e),n&&p(i,c)})(e,n)):(i.dataset.replyTo="",t.parentNode&&t.parentNode.removeChild(t))},m=e=>{if(!e)return;const t=e instanceof Event?e.target:e,n=r(),a=i(),c=n.contains(t)?a:n,o=n.contains(t)?n:a,l=c[t.name],s=t.type;if(l)if("radio"===s){const e=o[t.name];l.value=e.value}else if("checkbox"===s)l.checked=t.checked;else if("file"===s){const e=t.cloneNode(),n=l.parentElement;n.removeChild(l),n.insertBefore(e,n.firstChild)}else l.value=t.value},h=e=>{let t=e.target;for(;t&&!t.classList.contains("iichan-quick-reply-btn");)t=t.parentElement;if(t){const e=document.getElementById(t.dataset.postId);y(e)}e.preventDefault()},f=e=>{let n="";const a=u(e.target,".reply"),c=u(e.target,"[id^=thread]");if(a?n=a.id.substr("reply".length):c&&(n=c.id.substr("thread-".length)),n)if(t.parentNode){const t=r();p(t,n),e.preventDefault()}else if(document.body.classList.contains("replypage")){const t=i();p(t,n),e.preventDefault()}},k=e=>{if(L())return;const n=q(),i=r(),a=i.querySelector("textarea");(t.parentNode||a.value)&&(n.lastQuickReply=i.dataset.replyTo,n.lastUrl=window.location.href,n.timestamp=Date.now(),document.body.classList.contains("replypage")||(n.formData=(e=>{const t={},n=e.querySelectorAll("input, textarea");for(const i of n)if(i.name&&"file"!==i.type)if(t[i.name]={type:i.type},"radio"===i.type){const n=e[i.name];t[i.name].value=n.value}else"checkbox"===i.type?t[i.name].checked=i.checked:t[i.name].value=i.value;return t})(i))),x(n)},g=e=>{if(!e)return;const t=e.querySelector(":scope > .reflink");if(!t)return;let n=e.querySelector(".iichan-post-btns");n||((n=document.createElement("span")).classList.add("iichan-post-btns"),t.parentNode.insertBefore(n,t.nextSibling)),n.insertAdjacentHTML("beforeend",`\n    <div class="iichan-quick-reply-btn" title="Быстрый ответ" data-post-id="${e.id}">\n      <svg>\n        <use class="iichan-icon-reply-use" xlink:href="/extras/icons.svg#iichan-icon-reply" width="16" height="16" viewBox="0 0 16 16"/>\n      </svg>\n    </div>\n  `.trim()),e.querySelector(".iichan-quick-reply-btn").addEventListener("click",h);const i=t.querySelector("a");i&&i.addEventListener("click",f)},b=e=>{if(e&&e.matches(".reply, [id^=thread]"))return void g(e);const t=(e||document.body).querySelectorAll(".reply, [id^=thread]");for(const e of t)g(e)},v=()=>{const e=window.performance;if(!e)return!1;const t=e.navigation;return!!t&&(t.type===t.TYPE_RELOAD||t.type===t.TYPE_BACK_FORWARD)},q=()=>JSON.parse(window.localStorage.getItem("iichan_quick_reply")||"{}"),x=e=>window.localStorage.setItem("iichan_quick_reply",JSON.stringify(e)),L=()=>document.body.classList.contains("de-runned")||!!document.body.querySelector("#de-main"),S=()=>{if(L())return;if(document.getElementById("delform"),(()=>JSON.parse(window.localStorage.getItem("iichan_settings")||"{}"))().disable_quick_reply)return;const t=i();if(!t)return;window.addEventListener("beforeunload",k);const n=document.body.querySelector("#captcha");if(n){const t=n.getAttribute("src"),[i,r,a,c]=t.match(/([^\?]*)\?key=(.*)&dummy=(.*)/);e.main.url=r,e.main.key=a,e.main.dummy=c,e.quick.url=r}if(c(t),document.body.classList.contains("replypage")&&(t.addEventListener("change",m),t.addEventListener("input",m)),document.head.insertAdjacentHTML("beforeend",'<style type="text/css">\n      .iichan-quick-reply-btn {\n        display: inline-block;\n        width: 16px;\n        height: 16px;\n        vertical-align: text-top;\n      }\n      \n      .iichan-quick-reply-btn > svg {\n        width: 16px;\n        height: 16px;\n      }\n      \n      .iichan-quick-reply-btn use {\n        pointer-events: none;\n      }\n      \n      .iichan-quick-reply-btn {\n        margin-left: 0.4em;\n        cursor: pointer;\n      }\n      \n      #iichan-quick-reply-container .rules {\n        display: none;\n      }\n      \n      #iichan-quick-reply-icons {\n        display: none;\n      }\n      \n      .iichan-postform-container .theader {\n        width: auto;\n      }\n      \n      .iichan-quick-reply-close-form-btn {\n        float: right;\n        cursor: pointer;\n        padding: 1px;\n      }\n      \n      .iichan-quick-reply-close-form-btn svg {\n        width: 16px;\n        height: 16px;\n        vertical-align: text-top;\n      }\n      \n      .iichan-quick-reply-close-form-btn use {\n        pointer-events: none;\n      }\n      \n    </style>'),b(),(()=>{if(L())return;const e=q();if(e.lastUrl!==window.location.href||!e.timestamp)return;const t=Date.now()-e.timestamp;if(!v()||t>18e4)return e.lastUrl=null,e.lastQuickReply=null,e.timestamp=null,e.formData=null,void x(e);if(e.lastQuickReply){const t=document.getElementById(e.lastQuickReply);y(t,!1)}!document.body.classList.contains("replypage")&&e.formData&&((e,t)=>{const n=e.querySelectorAll("input, textarea");for(const i of n)t[i.name]&&t[i.name].type===i.type&&("radio"===i.type?e[i.name].value=t[i.name].value:"checkbox"===i.type?i.checked=t[i.name].checked:i.value=t[i.name].value)})(r(),e.formData);e.lastUrl=null,e.lastQuickReply=null,e.timestamp=null,e.formData=null,x(e)})(),"MutationObserver"in window){new MutationObserver(e=>{L()||e.forEach(e=>{for(const t of e.addedNodes){if(!t.querySelectorAll)return;b(t)}})}).observe(document.body,{childList:!0,subtree:!0})}};document.body?S():document.addEventListener("DOMContentLoaded",S)})();