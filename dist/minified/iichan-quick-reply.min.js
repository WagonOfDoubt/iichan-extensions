(()=>{const e={main:{key:"mainpage",dummy:"",url:"/cgi-bin/captcha1.pl/b/"},quick:{key:"mainpage",dummy:"",url:"/cgi-bin/captcha1.pl/b/"}},{quickReplyContainer:t,quickPostformContainer:n}=(()=>{const e=document.createElement("table");return e.insertAdjacentHTML("beforeend",'\n      <tr>\n      \t<td class="doubledash">&gt;&gt;</td>\n      \t<td class="iichan-postform-container reply">\n         <div class="theader">Ответ в тред №<span class="iichan-quick-reply-thread"></span><div class="iichan-quick-reply-close-form-btn" title="Закрыть форму"><svg>\n          <use class="iichan-icon-form-close-use" xlink:href="/extras/icons.svg#iichan-icon-close" width="16" height="16" viewBox="0 0 16 16"/>\n        </svg></div></div>\n        </td>\n      </tr>\n      \n    '),e.id="iichan-quick-reply-container",e.querySelector(".iichan-quick-reply-close-form-btn").addEventListener("click",e=>h(null)),{quickReplyContainer:e,quickPostformContainer:e.querySelector(".iichan-postform-container")}})(),i=(()=>{let e;return()=>(e||(e=document.getElementById("postform")),e)})(),r=(()=>{let e;return()=>{if(!e){const t=i();(e=t.cloneNode(!0)).id="iichan-quick-reply-form";const r=e.querySelector("#captcha");r&&(r.id="iichan-quick-reply-captcha"),a(e),document.body.classList.contains("replypage")&&(e.addEventListener("change",y),e.addEventListener("input",y)),n.appendChild(e)}return e}})(),c=(()=>{const e=document.createElement("input");return e.setAttribute("type","hidden"),e.setAttribute("name","parent"),e})(),a=e=>{const t=e.querySelector("input[name=captcha] + a");t&&(t.removeAttribute("onclick"),t.addEventListener("click",e=>{s(),e.preventDefault()}))},o=e=>{const{url:t,key:n,dummy:i}=e;return`${t}?key=${n}&dummy=${i}&${Math.random()}`},s=()=>{const t=document.getElementById("iichan-quick-reply-captcha"),n=document.getElementById("captcha"),i=o(e.quick);t&&(t.src=i),n&&(e.quick.key===e.main.key?n.src=i:n.src=o(e.main))},l=t=>{if(t){const n=t.id.substr("thread-".length),i=t.querySelector("table:last-child .reply"),r=i?i.id.substr("reply".length):n;e.quick.key=`res${n}`,e.quick.dummy=r}else e.quick.key="mainpage",e.quick.dummy="";s()},d=(e,n)=>{const i=t.querySelector(".iichan-quick-reply-thread");i&&(i.textContent=n||"");let r=e.querySelector("[name=parent]");n?(r||(r=c,e.appendChild(r)),r.setAttribute("value",n)):r&&e.removeChild(r)},u=(e,t)=>{let n=e;for(;n&&n!==document&&!n.matches(t);)n=n.parentNode;return n===document?null:n},p=(e,t)=>{const n=e&&e.querySelector("[name=nya4]");n&&(n.focus(),t&&(t=`>>${t}\n`,n.value.endsWith(t)||(n.value.length&&!n.value.endsWith("\n")&&(t="\n"+t),n.setRangeText(t,n.textLength,n.textLength,"end"))),document.body.classList.contains("replypage")&&y(n))},h=e=>{const n=r();e&&n.dataset.replyTo!==e.id?e.classList.contains("reply")?(n.dataset.replyTo=e.id,(e=>{const n=r(),i=u(e,"table"),c=u(e,"[id^=thread]");if(!i||!c)return;const a=c.id.substr("thread-".length),o=e.id.substr("reply".length);i.parentNode.insertBefore(t,i.nextSibling),d(n,a),l(c),p(n,o)})(e)):(n.dataset.replyTo=e.id,(e=>{const n=r(),i=e.querySelector("table"),c=e.id.substr("thread-".length);e.insertBefore(t,i),d(n,c),l(e),p(n,c)})(e)):(n.dataset.replyTo="",t.parentNode&&t.parentNode.removeChild(t))},y=e=>{const t=e instanceof Event?e.target:e,n=r(),c=i(),a=n.contains(t)?c:n,o=n.contains(t)?n:c,s=a[t.name],l=t.type;if(s)if("radio"===l){const e=o[t.name];s.value=e.value}else if("checkbox"===l)s.checked=t.checked;else if("file"===l){const e=t.cloneNode(),n=s.parentElement;n.removeChild(s),n.insertBefore(e,n.firstChild)}else s.value=t.value},m=e=>{let t=e.target;for(;t&&!t.classList.contains("iichan-quick-reply-btn");)t=t.parentElement;if(t){const e=document.getElementById(t.dataset.postId);h(e)}e.preventDefault()},f=e=>{let n="";const c=u(e.target,".reply"),a=u(e.target,"[id^=thread]");if(c?n=c.id.substr("reply".length):a&&(n=a.id.substr("thread-".length)),n)if(t.parentNode){const e=r();p(e,n)}else if(document.body.classList.contains("replypage")){const e=i();p(e,n)}else{h(c||a)}e.preventDefault()},b=e=>{if(!e)return;const t=e.querySelector(":scope > .reflink");if(!t)return;let n=e.querySelector(".iichan-post-btns");n||((n=document.createElement("span")).classList.add("iichan-post-btns"),t.parentNode.insertBefore(n,t.nextSibling)),n.insertAdjacentHTML("beforeend",`\n    <div class="iichan-quick-reply-btn" title="Быстрый ответ" data-post-id="${e.id}">\n      <svg>\n        <use class="iichan-icon-reply-use" xlink:href="/extras/icons.svg#iichan-icon-reply" width="16" height="16" viewBox="0 0 16 16"/>\n      </svg>\n    </div>\n  `.trim()),e.querySelector(".iichan-quick-reply-btn").addEventListener("click",m);const i=t.querySelector("a");i&&i.addEventListener("click",f)},g=e=>{if(e&&e.matches(".reply, [id^=thread]"))return void b(e);const t=(e||document.body).querySelectorAll(".reply, [id^=thread]");for(const e of t)b(e)},k=()=>document.body.classList.contains("de-runned")||!!document.body.querySelector("#de-main"),q=()=>{if(k())return;if((()=>JSON.parse(window.localStorage.getItem("iichan_settings")||"{}"))().disable_quick_reply)return;const t=i();if(!t)return;const n=document.body.querySelector("#captcha");if(n){const t=n.getAttribute("src"),[i,r,c,a]=t.match(/([^\?]*)\?key=(.*)&dummy=(.*)/);e.main.url=r,e.main.key=c,e.main.dummy=a,e.quick.url=r}if(a(t),document.body.classList.contains("replypage")&&(t.addEventListener("change",y),t.addEventListener("input",y)),document.head.insertAdjacentHTML("beforeend",'<style type="text/css">\n      .iichan-quick-reply-btn {\n        display: inline-block;\n        width: 16px;\n        height: 16px;\n        vertical-align: text-top;\n      }\n      \n      .iichan-quick-reply-btn > svg {\n        width: 16px;\n        height: 16px;\n      }\n      \n      .iichan-quick-reply-btn use {\n        pointer-events: none;\n      }\n      \n      .iichan-quick-reply-btn {\n        margin-left: 0.4em;\n        cursor: pointer;\n      }\n      \n      #iichan-quick-reply-container .rules {\n        display: none;\n      }\n      \n      #iichan-quick-reply-icons {\n        display: none;\n      }\n      \n      .iichan-postform-container .theader {\n        width: auto;\n      }\n      \n      .iichan-quick-reply-close-form-btn {\n        float: right;\n        cursor: pointer;\n        padding: 1px;\n      }\n      \n      .iichan-quick-reply-close-form-btn svg {\n        width: 16px;\n        height: 16px;\n        vertical-align: text-top;\n      }\n      \n      .iichan-quick-reply-close-form-btn use {\n        pointer-events: none;\n      }\n      \n    </style>'),g(),"MutationObserver"in window){new MutationObserver(e=>{k()||e.forEach(e=>{for(const t of e.addedNodes){if(!t.querySelectorAll)return;g(t)}})}).observe(document.body,{childList:!0,subtree:!0})}};document.body?q():document.addEventListener("DOMContentLoaded",q)})();